window.Mdjs={regs:{ul:/^[\*\-\+] +\S*/g,ol:/^\d+\. +\S*/g,delHTML:/<\/?[^<>]+>/g},tbAlign:["left","mid","right"],tag:{tBlock:["<blockquote><p>","</p></blockquote>\n"],tCode:['<pre><code data-lang="$lang">',"</code></pre>\n"],tList:["<li>","<ol>","<ul>","</li>"],tP:["<p>","</p>"],tToc:['<div class="md_toc">\n',"<ol>\n",'<a href="#$href"><li>',"</li></a>","</ol>","</div>\n"],tA:['<a href="mailto:','<a href="','">',"</a>"],tTable:['<table class="md_table">\n<thead>\n',"</thead>\n<tbody>\n","</tbody>\n</table>\n","<tr>","</tr>\n",'<th class="$align">',"</th>",'<td class="$align">',"</td>","md_table_"]},inlineTag:{tStrong:["<strong>","</strong>"],tEm:["<em>","</em>"],tCode:["<code>","</code>"],tA:['<a href="','">',"</a>"],tImg:['<img src="','" title="','" />']},_meaning:"#`*[]()-_{}+.!|\\",_inArray:function(t,i){for(var e=0;e<i.length;e++)if(t==i[e])return!0;return!1},_startWith:function(t,i){return t.length<i.length?!1:t.slice(0,i.length)==i},_endWith:function(t,i){return t.length<i.length?!1:t.slice(-i.length)==i},_isHr:function(t){var i=t[0];if("="!=i&&"-"!=i&&"_"!=i&&"*"!=i)return!1;for(var e=0,n=0;e<t.length;e++)if(" "!=t[e]&&"	"!=t[e]){if(t[e]!=i)return!1;n++}return n>=3},_isAList:function(t){return this._isHr(t)?0:-1!=t.search(this.regs.ol)?1:-1!=t.search(this.regs.ul)?2:0},_leftSpace:function(t){for(var i=0,e=0;e<t.length;e++)if(" "==t[e])i++;else{if("	"!=t[e])break;i+=4}return i},_genSpace:function(t){if(!this.gss){this.gss=" ";for(var i=0;10>i;i++)this.gss+=this.gss}return 0>=t?"":this.gss.slice(0,t)},_htmlSafer:function(t){var t=t.replace(/&/g,"&gt;");return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/\n/g,"</br>")},_isExpressAOrImg:function(t,i){for(;;){var e=t.indexOf("](",i);if(-1==e)return!1;if("\\"!=t[e-1]||"\\"==t[e-2])for(;;){if(e=t.indexOf(")",e+1),-1==e)return!1;if("\\"!=t[e-1]||"\\"==t[e-2])return!0}else i=e+2}},_inn:[],_inn2:[],_innLen:0,_iTop:function(){return 0==this._innLen?-1:this._inn[this._innLen-1]},_iTop2:function(){return this._inn2[this._innLen-1]},_iPush:function(t,i){this._inn[this._innLen]=t,this._inn2[this._innLen++]=i},_iPop:function(){return 0==this._innLen?!1:(this._innLen--,!0)},md2html:function(t,i){for(var e=[],n=0,r=0,s=t.length;s>n;n++){if("\r"==t[n])e.push(t.slice(r,n)),n+="\n"==t[n+1]?1:0;else{if("\n"!=t[n])continue;e.push(t.slice(r,n))}r=n+1}return s>r&&e.push(t.slice(r)),Mdjs.handlerLines(e)},handlerLines:function(t,i){for(var e="",n=0,r="",s=0,a=[],h=[],l=-1,g=[],f=[],o=0,c=-2,u="",d=0;d<t.length;d++)if(r=t[d].trim(),n>0){if("```"==r){n=0,e+=this.tag.tCode[1];continue}e+=(1==n?"":"\n")+this._htmlSafer(t[d]),n++}else{s=this._leftSpace(t[d]);var _=this._isAList(r);if(0==_)if(e+=this.handlerListEnd(),0!=r.length){if(4>s){if("```"==r.slice(0,3)){lang=r.slice(3).trim(),e+=this.tag.tCode[0].replace("$lang",lang),n=1;continue}for(var T=0;T<r.length&&"#"==r[T];T++);if(0!=T){var b=r.indexOf("#",T),m=-1==b?r.slice(T):r.slice(T,b),p=m=this.handlerInline(m,0);f[o]=T,g[o++]=p=p.trim().replace(this.regs.delHTML,""),e+="<h"+T+' id="'+p+'" name="'+p+'">'+m+"</h"+T+">\n";continue}if(">"==r[0]&&r.length>1){var v=[];v.push(r.slice(1));for(var L=d+1;L<t.length&&(u=t[L].trim(),0!=u.length);L++){if(">"==u[0])u=u.slice(1);else if(i)break;v.push(u)}e+=this.tag.tBlock[0]+this.handlerLines(v,!0)+this.tag.tBlock[1],d=L-1;continue}if(this._isHr(r)){e+="<hr />";continue}if("[TOC]"==r){l=e.length;continue}if(0!=(a=this.handlerTbLine(r))&&d<t.length-1&&0!=(h=this.handlerTbFmt(t[d+1].trim(),a.length))){e+=this.tag.tTable[0]+this.tag.tTable[3]+this.genTbTr(a,h,!0)+this.tag.tTable[4],e+=this.tag.tTable[1];for(var T=d+2;T<t.length&&0!=(a=this.handlerTbLine(t[T].trim()));T++)e+=this.tag.tTable[3]+this.genTbTr(a,h,!1)+this.tag.tTable[4];d=T-1,e+=this.tag.tTable[2];continue}}else if(0==d||0==t[d-1].trim().length){e+=this.tag.tCode[0].replace("$lang","");for(var k,A="",S=d,T=d;T<t.length;T++)if(0!=t[T].trim().length){if((k=this._leftSpace(t[T]))<4)break;e+=A+(T==d?"":"\n")+this._genSpace(k-2)+this._htmlSafer(t[T].trim()),A="",S=T}else A+="\n";e+=this.tag.tCode[1],d=S;continue}if(d+1<t.length&&(u=t[d+1].trim(),this._isHr(u))){var I=3;"="==u[0]?I=1:"-"==u[0]&&(I=2);var p=m=this.handlerInline(r,0);f[o]=I,g[o++]=p=p.trim().replace(this.regs.delHTML,""),e+="<h"+I+' id="'+p+'" name="'+p+'">'+m+"</h"+I+">\n",d++}else{u=this.handlerInline(r,0).trim();var C=this.inlineTag.tImg;e+=this._startWith(u,C[0])&&this._endWith(u,C[2])&&-1==u.indexOf(C[0],1)?u:this.tag.tP[0]+u+this.tag.tP[1]}}else c!=d-1&&(e+="<br />\n"),c=d;else e+=this.handlerList(s,_,r)}if(-1!=l){var O=e.slice(0,l);e=e.slice(l),e=O+this.handlerTOC(g,f,o)+e}return e},handlerTOC:function(t,i,e){for(var n,r=this.tag.tToc[0],s=[],a=0,h=0;e>h;h++)n=this.tag.tToc[2].replace("$href",t[h])+t[h]+this.tag.tToc[3],0==a||i[h]>s[a-1]?(r+=this.tag.tToc[1]+n,s[a++]=i[h]):i[h]==s[a-1]?r+=n:(r+=this.tag.tToc[4],a--,h--);for(;a-- >0;)r+=this.tag.tToc[4];return r+this.tag.tToc[5]},handlerListEnd:function(){for(var t="";-1!=this._iTop();)t+=1==this._iTop2()?"</ol>\n":"</ul>\n",this._iPop();return t},handlerList:function(t,i,e){var n=this._iTop(),r=this.tag.tList[0]+this.handlerInline(e,e.indexOf(" "),0)+this.tag.tList[3],s="";if(t>n)return this._iPush(t,i),this.tag.tList[i]+r;if(t==n)return r;for(;n>t;)s+=1==this._iTop2()?"</ol>\n":"</ul>\n",this._iPop(),n=this._iTop();return-1==n?(this._iPush(t,i),s+this.tag.tList[i]+r):s+r},genTbTr:function(t,i,e){for(var n="",r=0;r<t.length;r++)n+=this.tag.tTable[e?5:7].replace("$align",this.tag.tTable[9]+this.tbAlign[i[r]])+this.handlerInline(t[r],0)+this.tag.tTable[e?6:8];return n},handlerTbFmt:function(t,i){var e=this.handlerTbLine(t,!0),n=[],r=0,s=0;if(0==e)return!1;for(var a=e.length;a>r;r++,s=0)e[r].length<=1?n[r]=0:(":"==e[r][e[r].length-1]&&(s=":"==e[r][0]?1:2),n[r]=s);for(;i>r;r++)n[r]=0;return n},handlerTbLine:function(t,i){var e=[],n=t.length,r="";void 0==i&&(i=!1);for(var s="|"==t[0]?1:0;n>s;s++){switch(t[s]){case"\\":if(i)return!1;r+="\\","|"==t[s+1]&&(r+="|",s++);continue;case"|":if(r=r.trim(),i&&0==r.length)return!1;e.push(r),r="";continue}if(i&&":"!=t[s]&&"-"!=t[s]&&" "!=t[s]&&"	"!=t[s])return!1;r+=t[s]}return 0==e.length&&"|"!=t[0]?!1:(r=r.trim(),0!=r.length&&e.push(r),e)},handlerInline:function(t,i){for(var e=t+"\\",n=e.length-1,r="",s=0,a=0,h=0,l="*",g="*",f=!1,o="a",c=!1,u="",d="",_=0,T=!0,b=0>i?0:i;n>b;b++)switch(e[b]){case"\\":d=this._inArray(e[b+1],this._meaning)?e[++b]:e[b],c?u+=d:r+=d;break;case"`":r+=this.inlineTag.tCode[h],h=1^h;break;case"*":case"_":if(f)r+=e[b];else if(e[b+1]==e[b]){if(0==s)l=e[b];else if(e[b]!=l){c?u+=e[b]+e[b]:r+=e[b]+e[b],b++;break}r+=this.inlineTag.tStrong[s],s=1^s,b++}else{if(0==a)g=e[b];else if(e[b]!=g){c?u+=e[b]:r+=e[b];break}r+=this.inlineTag.tEm[a],a=1^a}break;case"!":if(c){if("["!=e[b+1]){u+="!";break}for(var m=!1,p=b+2;n>p;p++)if("\\"==e[p])p++;else if("]"==e[p]){if("("!=e[p+1]){p=n;break}m=!0,p++}else if(")"==e[p]&&m)break;n>p?(u+=this.handlerInline(e.slice(b,p+1),0),b=p):u+="!"}else"["==e[b+1]?o="i":r+="!";break;case"[":T=this._isExpressAOrImg(e,b),!T||f?(d="[","!"==e[b-1]&&(d="![",o=""),c?u+=d:r+=d):(f=!0,c=!0,u="");break;case"]":f?c=!1:c?u+="]":r+="]";break;case"(":if(!f){r+="(";break}if(c){u+="(";break}r+="i"==o?this.inlineTag.tImg[0]:this.inlineTag.tA[0];break;case")":if(!f){r+=")";break}if(c){u+=")";break}r+="i"==o?this.inlineTag.tImg[1]:this.inlineTag.tA[1],r+="i"==o?this._htmlSafer(u)+this.inlineTag.tImg[2]:u+this.inlineTag.tA[2],o="",f=!1;break;case"<":if(!c){if(_=e.indexOf(">",b),-1==_){c?u+=e[b]:r+="&lt;";break}if(d=e.slice(b+1,_),-1==d.search(/$\/?[\w ]*^/g)){if(0==d.search(/^\w+:\/\/\S*/g)){r+=this.tag.tA[1]+d+this.tag.tA[2]+d+this.tag.tA[3],b=_;break}if(0==d.search(/^\S+@\S+\.\w+$/g)){r+=this.tag.tA[0]+d+this.tag.tA[2]+d+this.tag.tA[3],b=_;break}}}default:c?u+=e[b]:r+=e[b]}return 1==h&&(r+=this.inlineTag.tCode[1]),1==a&&(r+=this.inlineTag.tEm[1]),1==s&&(r+=this.inlineTag.tStrong[1]),r}};