window.Mdjs={regs:{ul:/^[\*\-\+] +\S*/g,ol:/^\d+\. +\S*/g,delHTML:/<\/?[^<>]+>/g},tbAlign:["left","mid","right"],tag:{tBlock:["<blockquote><p>","</p></blockquote>\n"],tCode:['<pre><code data-lang="$lang">',"</code></pre>\n"],tList:["<li>","<ol>","<ul>","</li>"],tP:["<p>","</p>"],tToc:['<div class="md_toc">\n',"<ol>\n",'<a href="#$href"><li>',"</li></a>","</ol>","</div>\n"],tA:['<a href="mailto:','<a href="','">',"</a>"],tTable:['<table class="md_table">\n<thead>\n',"</thead>\n<tbody>\n","</tbody>\n</table>\n","<tr>","</tr>\n",'<th class="$align">',"</th>",'<td class="$align">',"</td>","md_table_"]},inlineTag:{tStrong:["<strong>","</strong>"],tEm:["<em>","</em>"],tCode:["<code>","</code>"],tA:['<a href="','">',"</a>"],tImg:['<img src="','" title="','" />']},_meaning:"#`*[]()-_{}+.!|\\",_inArray:function(t,i){for(var e=0;e<i.length;e++)if(t==i[e])return!0;return!1},_isHr:function(t){var i=t[0];if("="!=i&&"-"!=i&&"_"!=i&&"*"!=i)return!1;for(var e=0,n=0;e<t.length;e++)if(" "!=t[e]&&"	"!=t[e]){if(t[e]!=i)return!1;n++}return n>=3},_isAList:function(t){return this._isHr(t)?0:-1!=t.search(this.regs.ol)?1:-1!=t.search(this.regs.ul)?2:0},_leftSpace:function(t){for(var i=0,e=0;e<t.length;e++)if(" "==t[e])i++;else{if("	"!=t[e])break;i+=4}return i},_htmlSafer:function(t){var t=t.replace(/&/g,"&gt;");return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/\n/g,"</br>")},_isExpressAOrImg:function(t,i){for(;;){var e=t.indexOf("](",i);if(-1==e)return!1;if("\\"!=t[e-1]||"\\"==t[e-2])for(;;){if(e=t.indexOf(")",e+1),-1==e)return!1;if("\\"!=t[e-1]||"\\"==t[e-2])return!0}else i=e+2}},_inn:[],_inn2:[],_innLen:0,_iTop:function(){return 0==this._innLen?-1:this._inn[this._innLen-1]},_iTop2:function(){return this._inn2[this._innLen-1]},_iPush:function(t,i){this._inn[this._innLen]=t,this._inn2[this._innLen++]=i},_iPop:function(){return 0==this._innLen?!1:(this._innLen--,!0)},md2html:function(t,i){for(var e=[],n=0,r=0,a=t.length;a>n;n++){if("\r"==t[n])e.push(t.slice(r,n)),n+="\n"==t[n+1]?1:0;else{if("\n"!=t[n])continue;e.push(t.slice(r,n))}r=n+1}return a>r&&e.push(t.slice(r)),Mdjs.handlerLines(e)},handlerLines:function(t){for(var i="",e=0,n="",r=0,a=[],s=[],h=-1,l=[],g=[],f=0,o="",c=0;c<t.length;c++)if(n=t[c].trim(),e>0){if("```"==n){e=0,i+=this.tag.tCode[1];continue}i+=(1==e?"":"\n")+this._htmlSafer(t[c]),e++}else{r=this._leftSpace(t[c]);var u=this._isAList(n);if(0==u)if(i+=this.handlerListEnd(),0!=n.length){if(4>r){if("```"==n.slice(0,3)){lang=n.slice(3).trim(),i+=this.tag.tCode[0].replace("$lang",lang),e=1;continue}for(var d=0;d<n.length&&"#"==n[d];d++);if(0!=d){var T=n.indexOf("#",d),b=-1==T?n.slice(d):n.slice(d,T),_=b=this.handlerInline(b,0);g[f]=d,l[f++]=_=_.trim().replace(this.regs.delHTML,""),i+="<h"+d+' id="'+_+'" name="'+_+'">'+b+"</h"+d+">\n";continue}if(">"==n[0]&&n.length>1){i+=this.tag.tBlock[0]+this.handlerInline(n,1)+"<br />\n";for(var m=c+1;m<t.length&&(o=t[m].trim(),0!=o.length);m++)">"==o[0]&&(o=o.slice(1)),i+=this.handlerInline(o,0)+"<br />\n";i+=this.tag.tBlock[1],c=m-1;continue}if(this._isHr(n)){i+="<hr />";continue}if("[TOC]"==n){h=i.length;continue}if(0!=(a=this.handlerTbLine(n))&&c<t.length-1&&0!=(s=this.handlerTbFmt(t[c+1].trim(),a.length))){i+=this.tag.tTable[0]+this.tag.tTable[3]+this.genTbTr(a,s,!0)+this.tag.tTable[4],i+=this.tag.tTable[1];for(var d=c+2;d<t.length&&0!=(a=this.handlerTbLine(t[d].trim()));d++)i+=this.tag.tTable[3]+this.genTbTr(a,s,!1)+this.tag.tTable[4];c=d-1,i+=this.tag.tTable[2];continue}}else if(0==c||0==t[c-1].trim().length){i+=this.tag.tCode[0].replace("$lang","")+this._htmlSafer(t[c]);for(var d=c+1;d<t.length&&!(this._leftSpace(t[d])<4);d++)i+="\n"+this._htmlSafer(t[d]);i+=this.tag.tCode[1],c=d-1;continue}if(c+1<t.length&&(o=t[c+1].trim(),this._isHr(o))){var p=3;"="==o[0]?p=1:"-"==o[0]&&(p=2);var _=b=this.handlerInline(n,0);g[f]=p,l[f++]=_=_.trim().replace(this.regs.delHTML,""),i+="<h"+p+' id="'+_+'" name="'+_+'">'+b+"</h"+p+">\n",c++}else i+=this.tag.tP[0]+this.handlerInline(n,0)+this.tag.tP[1]}else i+="<br />\n";else i+=this.handlerList(r,u,n)}if(-1!=h){var v=i.slice(0,h);i=i.slice(h),i=v+this.handlerTOC(l,g,f)+i}return i},handlerTOC:function(t,i,e){for(var n,r=this.tag.tToc[0],a=[],s=0,h=0;e>h;h++)n=this.tag.tToc[2].replace("$href",t[h])+t[h]+this.tag.tToc[3],0==s||i[h]>a[s-1]?(r+=this.tag.tToc[1]+n,a[s++]=i[h]):i[h]==a[s-1]?r+=n:(r+=this.tag.tToc[4],s--,h--);for(;s-- >0;)r+=this.tag.tToc[4];return r+this.tag.tToc[5]},handlerListEnd:function(){for(var t="";-1!=this._iTop();)t+=1==this._iTop2()?"</ol>\n":"</ul>\n",this._iPop();return t},handlerList:function(t,i,e){var n=this._iTop(),r=this.tag.tList[0]+this.handlerInline(e,e.indexOf(" "),0)+this.tag.tList[3],a="";if(t>n)return this._iPush(t,i),this.tag.tList[i]+r;if(t==n)return r;for(;n>t;)a+=1==this._iTop2()?"</ol>\n":"</ul>\n",this._iPop(),n=this._iTop();return-1==n?(this._iPush(t,i),a+this.tag.tList[i]+r):a+r},genTbTr:function(t,i,e){for(var n="",r=0;r<t.length;r++)n+=this.tag.tTable[e?5:7].replace("$align",this.tag.tTable[9]+this.tbAlign[i[r]])+this.handlerInline(t[r],0)+this.tag.tTable[e?6:8];return n},handlerTbFmt:function(t,i){var e=this.handlerTbLine(t,!0),n=[],r=0,a=0;if(0==e)return!1;for(var s=e.length;s>r;r++,a=0)e[r].length<=1?n[r]=0:(":"==e[r][e[r].length-1]&&(a=":"==e[r][0]?1:2),n[r]=a);for(;i>r;r++)n[r]=0;return n},handlerTbLine:function(t,i){var e=[],n=t.length,r="";void 0==i&&(i=!1);for(var a="|"==t[0]?1:0;n>a;a++){switch(t[a]){case"\\":if(i)return!1;r+="\\","|"==t[a+1]&&(r+="|",a++);continue;case"|":if(r=r.trim(),i&&0==r.length)return!1;e.push(r),r="";continue}if(i&&":"!=t[a]&&"-"!=t[a]&&" "!=t[a]&&"	"!=t[a])return!1;r+=t[a]}return 0==e.length&&"|"!=t[0]?!1:(r=r.trim(),0!=r.length&&e.push(r),e)},handlerInline:function(t,i){for(var e=t+"\\",n=e.length-1,r="",a=0,s=0,h=0,l="*",g="*",f=!1,o="a",c=!1,u="",d="",T=0,b=!0,_=0>i?0:i;n>_;_++)switch(e[_]){case"\\":d=this._inArray(e[_+1],this._meaning)?e[++_]:e[_],c?u+=d:r+=d;break;case"`":r+=this.inlineTag.tCode[h],h=1^h;break;case"*":case"_":if(e[_+1]==e[_]){if(0==a)l=e[_];else if(e[_]!=l){c?u+=e[_]+e[_]:r+=e[_]+e[_],_++;break}r+=f?e[_]+e[_+1]:this.inlineTag.tStrong[a],a=1^a,_++}else{if(0==s)g=e[_];else if(e[_]!=g){c?u+=e[_]:r+=e[_];break}r+=f?e[_]:this.inlineTag.tEm[s],s=1^s}break;case"!":if(c){if("["!=e[_+1]){u+="!";break}for(var m=!1,p=_+2;n>p;p++)if("\\"==e[p])p++;else if("]"==e[p]){if("("!=e[p+1]){p=n;break}m=!0,p++}else if(")"==e[p]&&m)break;n>p?(u+=this.handlerInline(e.slice(_,p+1),0),_=p):u+="!"}else"["==e[_+1]?o="i":r+="!";break;case"[":b=this._isExpressAOrImg(e,_),!b||f?(d="[","!"==e[_-1]&&(d="![",o=""),c?u+=d:r+=d):(f=!0,c=!0,u="");break;case"]":f?c=!1:c?u+="]":r+="]";break;case"(":if(!f){r+="(";break}if(c){u+="(";break}r+="i"==o?this.inlineTag.tImg[0]:this.inlineTag.tA[0];break;case")":if(!f){r+=")";break}if(c){u+=")";break}r+="i"==o?this.inlineTag.tImg[1]:this.inlineTag.tA[1],r+="i"==o?this._htmlSafer(u)+this.inlineTag.tImg[2]:u+this.inlineTag.tA[2],o="",f=!1;break;case"<":if(!c){if(T=e.indexOf(">",_),-1==T){c?u+=e[_]:r+="&lt;";break}if(d=e.slice(_+1,T),-1==d.search(/$\/?[\w ]*^/g)){if(0==d.search(/^\w+:\/\/\S*/g)){r+=this.tag.tA[1]+d+this.tag.tA[2]+d+this.tag.tA[3],_=T;break}if(0==d.search(/^\S+@\S+\.\w+$/g)){r+=this.tag.tA[0]+d+this.tag.tA[2]+d+this.tag.tA[3],_=T;break}}}default:c?u+=e[_]:r+=e[_]}return 1==h&&(r+=this.inlineTag.tCode[1]),1==s&&(r+=this.inlineTag.tEm[1]),1==a&&(r+=this.inlineTag.tStrong[1]),r}};